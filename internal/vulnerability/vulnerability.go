package vulnerability

import (
	"context"
	"fmt"

	"github.com/nais/cli/internal/naisapi"
	"github.com/nais/cli/internal/naisapi/gql"
)

type Metadata struct {
	// CVE identifier, e.g. "CVE-2023-12345"
	CveId string
}

type WorkloadVulnerability = gql.FindWorkloadsForCveCveCVE

func FindWorkloadsForCve(ctx context.Context, cveId string) (*WorkloadVulnerability, error) {
	_ = `# @genqlient
		query FindWorkloadsForCve($identifier: String!) {
		  cve(identifier: $identifier) {
			id
			identifier
			severity
			title
			description
			detailsLink
			cvssScore
			workloads {
			  nodes {
				vulnerability {
				  package
				}
				workload {
				  __typename
				  name
				}
			  }
			}
		  }
		}
	`

	client, err := naisapi.GraphqlClient(ctx)
	if err != nil {
		return nil, err
	}

	resp, err := gql.FindWorkloadsForCve(ctx, client, cveId)
	if err != nil {
		return nil, err
	}

	return &resp.Cve, nil
}

func FormatDetails(w *WorkloadVulnerability) [][]string {
	return [][]string{
		{"Field", "Value"},
		{"CVE ID", w.Identifier},
		{"Title", w.Title},
		{"Description", w.Description},
		{"Severity", string(w.Severity)},
		{"CVSS Score", fmt.Sprintf("%.1f", w.CvssScore)},
		{"Details Link", w.DetailsLink},
	}
}

func FormatWorkloadsForCve(w *WorkloadVulnerability) [][]string {
	rows := [][]string{
		{"Workload Type", "Workload Name", "Vulnerable Package"},
	}
	for _, node := range w.Workloads.Nodes {
		rows = append(rows, []string{
			node.Workload.GetTypename(),
			node.Workload.GetName(),
			node.Vulnerability.Package,
		})
	}
	return rows
}
