package vulnerability

import (
	"context"
	"fmt"

	"github.com/nais/cli/internal/naisapi"
	"github.com/nais/cli/internal/naisapi/gql"
)

type Metadata struct {
	// CVE identifier, e.g. "CVE-2023-12345"
	CveId string
}

type WorkloadVulnerability = gql.FindWorkloadsForCveCveCVE

func FindWorkloadsForCve(ctx context.Context, metadata Metadata) (*WorkloadVulnerability, error) {
	_ = `# @genqlient
		query FindWorkloadsForCve($identifier: String!) {
		  cve(identifier: $identifier) {
			id
			identifier
			severity
			title
			description
			detailsLink
			cvssScore
			workloads {
			  nodes {
				vulnerability {
				  package
				  suppression {
					state
					}
				}
				workload {
				  __typename
				  name
				}
			  }
			}
		  }
		}
	`

	client, err := naisapi.GraphqlClient(ctx)
	if err != nil {
		return nil, err
	}

	resp, err := gql.FindWorkloadsForCve(ctx, client, metadata.CveId)
	if err != nil {
		return nil, err
	}

	return &resp.Cve, nil
}

func FormatDetails(w *WorkloadVulnerability, verbose bool) [][]string {
	rows := [][]string{
		{"Field", "Value"},
		{"CVE Id", w.Identifier},
		{"Title", w.Title},
		{"Severity", string(w.Severity)},
		{"CVSS Score", fmt.Sprintf("%.1f", w.CvssScore)},
		{"Details Link", w.DetailsLink},
	}

	if verbose {
		rows = append(rows, []string{"Description", w.Description})
	}

	return rows
}

func FormatWorkloadsForCve(w *WorkloadVulnerability) [][]string {
	rows := [][]string{
		{"Workload Name", "Workload Type", "Vulnerable Package", "Suppress State"},
	}

	for _, node := range w.Workloads.Nodes {
		suppressState := "N/A"
		if node.Vulnerability.Suppression.State != "" {
			suppressState = string(node.Vulnerability.Suppression.State)
		}

		rows = append(rows, []string{
			node.Workload.GetName(),
			node.Workload.GetTypename(),
			node.Vulnerability.Package,
			suppressState,
		})
	}

	return rows
}
