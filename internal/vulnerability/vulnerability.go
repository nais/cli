package vulnerability

import (
	"context"

	"github.com/nais/cli/internal/naisapi"
	"github.com/nais/cli/internal/naisapi/gql"
)

type WorkloadVulnerability = *gql.FindWorkloadsForCveCveCVE

func FindWorkloadsForCve(ctx context.Context, cveId string) (*WorkloadVulnerability, error) {
	_ = `# @genqlient
		query FindWorkloadsForCve($identifier: String!) {
		  cve(identifier: $identifier) {
			id
			identifier
			severity
			title
			description
			detailsLink
			cvssScore
			workloads {
			  nodes {
				vulnerability {
				  package
				}
				workload {
				  __typename
				  name
				}
			  }
			}
		  }
		}
	`

	client, err := naisapi.GraphqlClient(ctx)
	if err != nil {
		return nil, err
	}

	resp, err := gql.FindWorkloadsForCve(ctx, client, cveId)
	if err != nil {
		return nil, err
	}

	return resp.Cve, nil
}
